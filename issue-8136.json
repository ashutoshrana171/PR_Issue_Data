{"source": "https://github.com/QuantConnect/Lean", "title": "Option Position Match Finds Optimal Strategy (Lowest Margin Required)", "link": "https://github.com/QuantConnect/Lean/issues/8136", "state": "open", "created_by": "AlexCatarino", "created_at": "2024-07-02T17:50:31Z", "updated_at": "2024-07-02T17:50:31Z", "closed_at": null, "body": "#### Expected Behavior\r\nLEAN matches options legs to find the combination that requires less margin.\r\n\r\n#### Actual Behavior\r\nLEAN matches options legs that don't have the minimum margin requirement.\r\n\r\n#### Potential Solution\r\nN/A\r\n\r\n#### Reproducing the Problem\r\nBuy two bear call spread with different strikes: Spread 1 (A > B) > Spread 2 (C > D). On `OptionEquityBearCallSpreadRegressionAlgorithm`, add:\r\n\r\n```csharp\r\ncallContracts = callContracts.Where(contract => contract.Strike > longCall.Strike && contract.Expiry == longCall.Expiry).ToList();\r\nMarketOrder(callContracts[0].Symbol, -5);\r\nAssertOptionStrategyIsPresent(OptionStrategyDefinitions.ShortButterflyCall.Name, 2);\r\nMarketOrder(callContracts[1].Symbol, 5);\r\nAssertOptionStrategyIsPresent(OptionStrategyDefinitions.BearCallSpread.Name, 10);\r\n```\r\n\r\nOn `OptionEquityBaseStrategyRegressionAlgorithm`, we need to increase the strike range to +5:\r\n```csharp\r\nu.Strikes(-2, +5)\r\n```\r\n\r\nWe should have two bear call spread with 10 contracts, but we have:\r\n2 Butterfly Calls\r\n1 Short Butterfly Call\r\n4 Bear Call Spread\r\n\r\nAnd we used the Short Butterfly Call to get the margin.\r\n\r\nThe backtest on the following thread also reproduces the issue:\r\nhttps://www.quantconnect.com/forum/discussion/17414/unexpected-remaining-margin-decrease/p1\r\n\r\n#### Checklist\r\n- [x] I have completely filled out this template\r\n- [x] I have confirmed that this issue exists on the current `master` branch\r\n- [x] I have confirmed that this is not a duplicate issue by searching [issues](https://github.com/QuantConnect/Lean/issues)\r\n- [x] I have provided detailed steps to reproduce the issue", "comments": []}